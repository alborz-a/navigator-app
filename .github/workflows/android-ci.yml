name: Navigator App CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    tags: ['v*']

env:
  FLEETBASE_KEY: ${{ secrets.FLEETBASE_KEY }}
  GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
  TRANSISTORSOFT_LICENSE_KEY: ${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}
  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

jobs:
  install_and_test:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate Yarn 3.6.4
        run: corepack prepare yarn@3.6.4 --activate

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v4
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Create .env file (install_and_test)
        run: |
          echo "APP_LINK_PREFIX=${{ secrets.APP_LINK_PREFIX }}" > .env
          echo "FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}" >> .env
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" >> .env
          echo "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" >> .env
          echo "FACEBOOK_CLIENT_TOKEN=${{ secrets.FACEBOOK_CLIENT_TOKEN }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> .env
          echo "TRANSISTORSOFT_LICENSE_KEY=${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}" >> .env

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-deps-${{ hashFiles('**/yarn.lock', '**/package.json') }}" >> $GITHUB_OUTPUT

  android_build:
    runs-on: ubuntu-latest
    needs: install_and_test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate Yarn 3.6.4
        run: corepack prepare yarn@3.6.4 --activate

      - name: Cache yarn & node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.yarn/cache
            **/node_modules
          key: ${{ needs.install_and_test.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Create .env file (android_build)
        run: |
          echo "APP_LINK_PREFIX=${{ secrets.APP_LINK_PREFIX }}" > .env
          echo "FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}" >> .env
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" >> .env
          echo "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" >> .env
          echo "FACEBOOK_CLIENT_TOKEN=${{ secrets.FACEBOOK_CLIENT_TOKEN }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> .env
          echo "TRANSISTORSOFT_LICENSE_KEY=${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}" >> .env

      - name: Generate google-services.json (from secret) and validate
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          # create directory and write file preserving newlines
          mkdir -p android/app
          printf '%s' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json

          # Validate JSON quickly; fail early if malformed
          python - <<'PY'
import json,sys
try:
  json.load(open('android/app/google-services.json', 'rb'))
  print('google-services.json -> valid JSON')
except Exception as e:
  print('Invalid google-services.json:', e)
  sys.exit(1)
PY

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Ninja (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Ensure Android SDK/NDK/CMake toolchain
        shell: bash
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          set -e

          # Find a working sdkmanager (latest if present, else first found)
          if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          else
            SDKMGR=$(ls -1d "$ANDROID_SDK_ROOT/cmdline-tools"/*/bin/sdkmanager 2>/dev/null | head -n1 || true)
            if [ -z "$SDKMGR" ]; then
              echo "No cmdline-tools found; installing 'cmdline-tools;latest' with the preinstalled sdkmanager..."
              # Use the prebundled sdkmanager path on GH runners
              SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/bin/sdkmanager"
              "$SDKMGR" "cmdline-tools;latest"
              SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
            fi
          fi

          echo "Using sdkmanager at: $SDKMGR"

          # Accept licenses; don't fail on SIGPIPE from 'yes'
          yes | "$SDKMGR" --licenses >/dev/null 2>&1 || true

          # Helper: install component if missing
          need() {
            local p="$1"
            if ! "$SDKMGR" --list_installed | grep -q "^  $p$"; then
              echo "Installing $p"
              "$SDKMGR" "$p"
            else
              echo "✓ $p already installed"
            fi
          }

          # Match project pins (adjust if you change compileSdkVersion)
          need "platforms;android-35"
          need "build-tools;35.0.0"
          need "ndk;27.1.12297006"
          need "cmake;3.22.1"

          # Sanity output
          "$ANDROID_SDK_ROOT/cmake/3.22.1/bin/cmake" --version || true
          test -f "$ANDROID_SDK_ROOT/ndk/27.1.12297006/source.properties" && echo "✅ NDK 27.1.12297006 installed"

      - name: Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle-wrapper.properties') }}

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-caches-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-caches-

      - name: Make Gradlew Executable
        run: cd android && chmod +x ./gradlew

      - name: Build Android Debug APK
        run: |
          cd android
          ./gradlew clean assembleDebug --no-daemon --console=plain --stacktrace --info

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

  android_release:
    runs-on: ubuntu-latest
    needs: install_and_test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate Yarn 3.6.4
        run: corepack prepare yarn@3.6.4 --activate

      - name: Install dependencies
        run: yarn install --immutable

      - name: Create .env file (release)
        run: |
          echo "APP_LINK_PREFIX=${{ secrets.APP_LINK_PREFIX }}" > .env
          echo "FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}" >> .env
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" >> .env
          echo "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" >> .env
          echo "FACEBOOK_CLIENT_TOKEN=${{ secrets.FACEBOOK_CLIENT_TOKEN }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> .env
          echo "TRANSISTORSOFT_LICENSE_KEY=${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}" >> .env

      - name: Generate google-services.json (from secret)
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          mkdir -p android/app
          printf '%s' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json
          python - <<'PY'
import json,sys
try:
  json.load(open('android/app/google-services.json','rb'))
  print('google-services.json -> valid JSON')
except Exception as e:
  print('Invalid google-services.json:', e)
  sys.exit(1)
PY

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-caches-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build Android Release APK
        run: |
          cd android
          ./gradlew clean assembleRelease --no-daemon --console=plain --stacktrace

      - name: Upload Android Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 90
